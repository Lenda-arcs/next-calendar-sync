---
description: Unified data fetching guidelines using TanStack Query + Supabase for consistent, performant data management
alwaysApply: true
---

# ğŸ“¡ Unified Data Fetching Strategy

## âœ… NEW UNIFIED APPROACH (Use This!)

### Client Components - Use App-Specific Hooks
```typescript
// âœ… ALWAYS use these app-specific hooks
const { data, isLoading, error } = useAllTags(userId)
const { data: events } = useUserEvents(userId, filters)
const { data: profile } = useUserProfile(userId)

// âœ… For mutations
const { mutate: createTag } = useCreateTag()
const { mutate: updateEvent } = useUpdateEvent()
```

### Server Components - Use Data Access Functions
```typescript
// âœ… Use centralized data access functions
import { getAllTags, getUserProfile } from '@/lib/server/data-access'
import { createServerClient } from '@/lib/supabase-server'

const supabase = await createServerClient()
const tags = await getAllTags(supabase, userId)
const profile = await getUserProfile(supabase, userId)
```

### API Routes - Use Same Data Access Functions
```typescript
// âœ… Reuse the same functions in API routes
import { getAllTags } from '@/lib/server/data-access'
import { createServerClient } from '@/lib/supabase-server'

export async function GET() {
  const supabase = await createServerClient()
  const data = await getAllTags(supabase, userId)
  return NextResponse.json(data)
}
```

## ğŸ—ï¸ Architecture Layers

1. **Application Hooks** (`useAllTags`, `useUserEvents`) â†’ Use in components
2. **Unified Query Layer** (`useUnifiedQuery`, `useUnifiedMutation`) â†’ Building blocks
3. **Data Access Layer** (`getAllTags`, `getUserEvents`) â†’ Single source of truth
4. **Query Keys Factory** (`queryKeys.tags.allForUser(userId)`) â†’ Cache management
5. **TanStack Query** â†’ Caching, background updates, optimistic updates

## ğŸ“‹ Implementation Rules

### âœ… DO THIS
- **Always use app-specific hooks** like `useAllTags(userId)` in components
- **Use data access functions** like `getAllTags(supabase, userId)` in server components
- **Add new queries to data access layer first**, then create app hooks
- **Use query keys factory** for consistent cache invalidation
- **Handle loading and error states** in every component

### âŒ DON'T DO THIS
- Don't use `useSupabaseQuery` or `useSupabaseMutation` (legacy)
- Don't call `fetch('/api/route')` for internal data (use hooks instead)
- Don't write raw Supabase queries in components
- Don't create API routes for simple CRUD (use direct hooks)
- Don't forget to handle loading and error states

## ğŸš€ Adding New Data Fetching

1. **Add to data access layer**: `src/lib/server/data-access.ts`
   ```typescript
   export async function getNewData(supabase: SupabaseClient, params: string) {
     const { data, error } = await supabase.from('table').select('*')
     if (error) throw error
     return data
   }
   ```

2. **Add query keys**: `src/lib/query-keys.ts`
   ```typescript
   newData: {
     all: ['new-data'] as const,
     detail: (id: string) => ['new-data', 'detail', id] as const,
   }
   ```

3. **Create app hook**: `src/lib/hooks/useAppQuery.ts`
   ```typescript
   export function useNewData(params: string) {
     return useUnifiedQuery({
       queryKey: queryKeys.newData.detail(params),
       fetcher: (supabase) => dataAccess.getNewData(supabase, params),
       enabled: !!params,
     })
   }
   ```

4. **Use in components**: 
   ```typescript
   const { data, isLoading, error } = useNewData(params)
   ```

## ğŸ”„ Migration from Legacy Patterns

### Replace useSupabaseQuery
```typescript
// âŒ Old way
const { data } = useSupabaseQuery({
  queryKey: ['tags', userId],
  fetcher: async (supabase) => { /* complex query */ }
})

// âœ… New way  
const { data } = useAllTags(userId)
```

### Replace fetch() calls
```typescript
// âŒ Old way
const response = await fetch('/api/tags')
const data = await response.json()

// âœ… New way
const { data } = useAllTags(userId)
```

### Replace direct Supabase in components
```typescript
// âŒ Old way
const { data } = await supabase.from('tags').select('*')

// âœ… New way
const { data } = useAllTags(userId)
```

## ğŸ›ï¸ Development Tools

- **React Query Devtools** - Automatic in development, inspect cache
- **Query key debugging** - See cache keys in dev mode
- **Error boundaries** - Handle query errors gracefully
- **Loading states** - Use consistent loading UI patterns

---

**ğŸ¯ Goal: One consistent, performant, and maintainable data fetching pattern throughout the entire application.**